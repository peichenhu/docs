# HTTP/HTTPS

## 密钥和证书

### 对称加密

创建一个`密钥`，它可以加密一段信息，也可以对加密后的信息进行解密。

HTTP 不使用它是因为 HTTP 是明文传输，传输过程中密钥可能会被劫持。

### 非对称加密

创建一个`公钥`和一个`私钥`，用公钥加密的数据，只有对应的私钥才能解密；用私钥加密的数据，只有对应的公钥才能解密。比较耗时。

HTTP 不使用它是因为 HTTP 是明文传输，传输过程中公钥可能会被劫持并替换成假公钥和假私钥。

### 数字证书

数字证书是证书颁发机构用来保证公钥合法性的权威证书， 网站在使用 HTTPS 前，需要向 CA 机构申领一份数字证书，数字证书里含有证书持有者信息、公钥信息、数字防伪签名等。服务器把证书传输给浏览器，浏览器从证书里获取公钥就行了，证书就如身份证，证明“该公钥对应该网站”。

## HTTP

> 超文本传输协议，是一个基于请求与响应，无状态的，应用层的协议，常基于 TCP/IP 协议传输数据，互联网上应用最为广泛的一种网络协议,所有的 WWW 文件都必须遵守这个标准。设计 HTTP 的初衷是为了提供一种发布和接收 HTML 页面的方法。
>
> 默认端口 80

| 版本     | 产生时间 | 内容                                                                       | 发展现状            |
| -------- | -------- | -------------------------------------------------------------------------- | ------------------- |
| HTTP/0.9 | 1991 年  | 明文传输, 不涉及数据包传输，规定客户端和服务器之间通信格式，只能 GET 请求  | 没有作为正式的标准  |
| HTTP/1.0 | 1996 年  | 明文传输, 传输内容格式不限制，增加 PUT、PATCH、HEAD、 OPTIONS、DELETE 命令 | 正式作为标准        |
| HTTP/1.1 | 1997 年  | 明文传输, 持久连接(长连接)、节约带宽、HOST 域、管道机制、分块传输编码      | 2015 年前使用最广泛 |
| HTTP/2   | 2015 年  | 明文传输, 多路复用、服务器推送、头部压缩、二进制协议等                     | 逐渐覆盖市场        |

### 头部压缩

HTTP/2 针对头部字段，也采用了对应的压缩算法——HPACK，对请求头进行压缩。

1. 在服务器和客户端之间建立哈希表,将用到的字段存放在这张表中,传索引。
2. 其次是对于整数和字符串进行哈夫曼编码，哈夫曼编码的原理就是先将所有出现的字符建立一张索引表，然后让出现次数多的字符对应的索引尽可能短，传输的时候也是传输这样的索引序列，可以达到非常高的压缩率。

### 多路复用&二进制协议

在 HTTP/1 中，每次请求都会建立一次 HTTP 连接，也就是我们常说的 3 次握手 4 次挥手，这个过程在一次请求过程中占用了相当长的时间，即使开启了 Keep-Alive ，解决了多次连接的问题，但是依然有两个效率上的问题：

1. 串行的文件传输。当请求 a 文件时，b 文件只能等待，等待 a 连接到服务器、服务器处理文件、服务器返回文件，这三个步骤。我们假设这三步用时都是 1 秒，那么 a 文件用时为 3 秒，b 文件传输完成用时为 6 秒，依此类推。（注：此项计算有一个前提条件，就是浏览器和服务器是单通道传输）
2. 连接数过多。我们假设 Apache 设置了最大并发数为 300，因为浏览器限制，浏览器发起的最大请求数为 6，也就是服务器能承载的最高并发为 50，当第 51 个人访问时，就需要等待前面某个请求处理完成。

在 HTTP/2 中，有两个非常重要的概念，分别是`帧（frame）`和`流（stream）`。

-   帧代表着最小的数据单位，每个帧会标识出该帧属于哪个流
-   流也就是多个帧组成的数据流。

多路复用，就是在一个 TCP 连接中可以存在多条流。换句话说，也就是可以发送多个请求，对端可以通过帧中的标识知道属于哪个请求。这个技术可以避免阻塞问题，极大的提高传输性能

### 服务器推送

服务器能新建 stream 来给客户端主动发送消息，当 TCP 连接建立之后，比如浏览器请求一个 HTML 文件，服务器就可以在返回 HTML 的基础上，将 HTML 中引用到的其他资源文件一起返回给客户端，减少客户端的等待。

## HTTPS

> 《图解 HTTP》这本书中曾提过 HTTPS 是身披 SSL 外壳的 HTTP。HTTPS 是一种通过计算机网络进行安全通信的传输协议，经由 HTTP 进行通信，利用 SSL/TLS 建立全信道，加密数据包。HTTPS 使用的主要目的是提供对网站服务器的身份认证，同时保护交换数据的隐私与完整性。
>
> 默认端口 443
>
> TLS 是传输层加密协议，前身是 SSL 协议，由网景公司 1995 年发布，有时候两者不区分。

### HTTPS 握手过程

1. 某网站拥有用于 `公钥 A`、`私钥 A`、`CA证书 (包含公钥 A)`。
2. 浏览器向网站服务器请求，服务器把`CA证书 (包含公钥 A)` 明文给传输浏览器。
3. 浏览器随机生成一个`密钥 X`，用`公钥 A`加密后传给服务器。
4. 服务器拿到后用`私钥 A`解密得到`密钥 X`。
5. 这样双方就都拥有`密钥 X`了，且别人无法知道它。之后双方所有数据都通过`密钥 X` 加密解密即可。
6. 服务器使用 `TicketKey` 将本次的会话状态加密后生成一个 `Ticket(密钥 X 等信息)`，发给客户端，客户端存储并使用它进行会话复用。

## HTTP 状态码

-   `1**` 信息，服务器收到请求，需要请求者继续执行操作
-   `2**` 成功，操作被成功接收并处理
-   `3**` 重定向，需要进一步的操作以完成请求
-   `4**` 客户端错误，请求包含语法错误或无法完成请求
-   `5**` 服务器错误，服务器在处理请求的过程中发生了错误

常见状态码

-   **200** - 请求成功
-   **301** - 资源（网页等）被永久转移到其它 URL
-   **304** - 命中缓存未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。
-   **403** - 服务器理解请求客户端的请求，但是拒绝执行此请求
-   **404** - 请求的资源（网页等）不存在
-   **500** - 内部服务器错误

## 三次握手/四次挥手

首先要知道 ACK 应答报文；FIN 结束报文；SYN 同步报文。

    - 客户端发送一个TCP的SYN=1，Seq=X的包到服务器端口 ---(在吗，开门做生意吗？)
    - 服务器发回SYN=1， ACK=X+1， Seq=Y的响应包 -------(收到, 可以开门做生意。)
    - 客户端发送ACK=Y+1， Seq=Z ----------------------(收到，开搞。)

    - 主动方发送Fin=1， Ack=Z， Seq=X报文 -----(在吗？我可以关门嘛？)
    - 被动方发送ACK=X+1， Seq=Z报文------------(收到，我看看我这有没有人在交易？)
    - 被动方发送Fin=1， ACK=X， Seq=Y报文------(收到，交易完毕，现在关门)
    - 主动方发送ACK=Y， Seq=X报文--------------(好的，收到)

## 参考资料

-   [彻底搞懂 HTTPS 的加密原理](https://zhuanlan.zhihu.com/p/43789231)
-   [XSS 和 CSRF 简述及预防措施](https://www.cnblogs.com/yangsg/p/10621496.html)
-   [HTTPS 网站检测工具:证书链、安全性、性能、协议细节进行全面检测](https://www.ssllabs.com/ssltest/)
